- name: Provision EC2 via Terraform (with var file)
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    tf_build: "ansible01"
    terraform_working_dir: /tmp/srv/
    terraform_state: present

    tf_project_dir: "{{ terraform_working_dir }}/aws"
    tf_var_file: "{{ tf_project_dir }}/terraform.tfvars"

    aap_password: "{{ lookup('env', 'AAP_PASSWORD') }}"

  tasks:
    - name: Clone Terraform Repo
      ansible.builtin.git:
        repo: 'https://github.com/taiseerhussein/terraform-files.git'
        version: main
        accept_newhostkey: true
        # key_file: "{{ cert_key_file }}"
        dest: "{{ terraform_working_dir }}"

    - name: Terraform fmt (check)  # helpful preflight
      ansible.builtin.command:
        cmd: terraform fmt -check
        chdir: "{{ tf_project_dir }}"
      changed_when: false

    - name: Terraform validate
      ansible.builtin.command:
        cmd: terraform validate
        chdir: "{{ tf_project_dir }}"
      changed_when: false